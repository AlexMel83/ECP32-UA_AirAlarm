<!DOCTYPE html>
<html>
  <head>
    <title>Air Alarm UA</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
        text-align: center;
        height: 100vh;
        margin: 0;
        padding: 0;
      }

      .container {
        margin-top: 50px;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        border-radius: 50%;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
      }

      input:checked + .slider {
        background-color: #2196f3;
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      .timer {
        margin-top: 20px;
        font-size: 18px;
        color: #333;
      }
    </style>
  </head>
  <body>
    <h1>MEGATEX LLC</h1>
    <h2>Air Alerts in Starokostyantyniv UA</h2>

    <div class="container">
      <label class="switch">
        <input type="checkbox" id="relay_switch" />
        <span class="slider"></span>
      </label>
      <div style="text-align: left; margin: 20px auto; max-width: 400px">
        <div class="timer" id="timer">Time since last check: 0s</div>
        <div id="alarmStatus">Alarm Active: false</div>
        <div id="alarmStartTime">Alarm Start Time: 0</div>
        <div id="regionNames">Region Names:</div>
      </div>
    </div>

    <script>
      let relaySwitch = document.getElementById("relay_switch");
      let timerDisplay = document.getElementById("timer");
      let lastRequestTime = 0;
      let alarmStatusDisplay = document.getElementById("alarmStatus");
      let alarmStartTimeDisplay = document.getElementById("alarmStartTime");
      let regionNamesDisplay = document.getElementById("regionNames");

      // Функция для обновления таймера
      function updateTimer() {
        let currentMillis = Date.now();
        let elapsedTime = Math.floor((currentMillis - lastRequestTime) / 1000);
        timerDisplay.innerHTML = "Time since last check: " + elapsedTime + "s";
      }

      // Обработчик для переключателя
      relaySwitch.addEventListener("change", function () {
        let relayState = relaySwitch.checked ? "1" : "0";
        var request = new XMLHttpRequest();
        request.open("GET", "/relay_switch?state=" + relayState, true); // передаем состояние переключателя
        request.send();
      });

      // Функция для обновления состояния переключателя и другой информации
      function updateRelayState() {
        var request = new XMLHttpRequest();
        request.open("GET", "/relay_status", true);
        request.onload = function () {
          if (request.status == 200) {
            try {
              let data = JSON.parse(request.responseText);
              relaySwitch.checked = data.relayStatus === 1;
              lastRequestTime = Date.now(); // Обновляем время последнего запроса
              updateTimer(); // Обновляем таймер

              // Обновляем статус тревоги
              alarmStatusDisplay.innerHTML =
                "Alarm Active: " + data.alarmActive;
              alarmStartTimeDisplay.innerHTML =
                "Alarm Start Time: " +
                new Date(data.alarmStartTime).toLocaleString();

              // Обновляем список регионов
              let regionNames = "Region Names:<br>";
              if (data.regionNames && Array.isArray(data.regionNames)) {
                regionNames += data.regionNames
                  .map((region) => region.regionName)
                  .join("<br>");
              } else {
                regionNames += "No data";
              }
              regionNamesDisplay.innerHTML = regionNames;
            } catch (e) {
              console.error("Error parsing JSON: ", e);
              console.log("Response text: ", request.responseText);
            }
          }
        };
        request.onerror = function () {
          console.error("Request failed");
        };
        request.send();
      }

      // Инициализируем состояние реле при загрузке страницы
      window.onload = function () {
        updateRelayState();
        setInterval(updateTimer, 1000); // Обновляем таймер каждую секунду
        setInterval(updateRelayState, 5000); // Обновляем состояние реле и другую информацию каждые 5 секунд
      };
    </script>
  </body>
</html>
